<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Administración de Capítulos</h2>
    <button *ngIf="authService.canCreateContent()"
      class="btn btn-primary" 
      (click)="createChapter()"
      [disabled]="!selectedCourseId">
      <i class="fas fa-plus"></i> Nuevo Capítulo
    </button>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <label for="courseFilter" class="form-label">Seleccionar Curso</label>
          <select
            class="form-select"
            id="courseFilter"
            [(ngModel)]="selectedCourseId"
            (change)="onCourseChange()">
            <option [ngValue]="null">-- Selecciona un curso --</option>
            <option *ngFor="let course of courses" [ngValue]="course.id">
              {{ course.title }}
            </option>
          </select>
        </div>
        <div class="col-md-6 d-flex align-items-end">
          <div class="alert alert-info mb-0 w-100" *ngIf="selectedCourseName">
            <i class="fas fa-info-circle"></i> 
            Mostrando capítulos de: <strong>{{ selectedCourseName }}</strong>
          </div>
          <div class="alert alert-warning mb-0 w-100" *ngIf="!selectedCourseId">
            <i class="fas fa-exclamation-triangle"></i> 
            Selecciona un curso para ver sus capítulos
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="loading" class="text-center">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>

  <div *ngIf="error && !loading" class="alert alert-danger" role="alert">
    {{ error }}
  </div>

  <div *ngIf="!loading && !error && selectedCourseId" class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th style="width: 60px;">Orden</th>
              <th>Título</th>
              <th>Descripción</th>
              <th style="width: 100px;">Duración</th>
              <th style="width: 120px;">Estado</th>
              <th style="width: 300px;" class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let chapter of chapters; let i = index">
              <td class="text-center">
                <span class="badge bg-secondary">{{ chapter.orderIndex }}</span>
              </td>
              <td>
                <strong>{{ chapter.title }}</strong>
              </td>
              <td>
                <small class="text-muted">
                  {{ chapter.description || '-' }}
                </small>
              </td>
              <td>
                <span *ngIf="chapter.durationMinutes">
                  <i class="fas fa-clock"></i> {{ chapter.durationMinutes }} min
                </span>
                <span *ngIf="!chapter.durationMinutes">-</span>
              </td>
              <td>
                <span class="badge" [ngClass]="getStateBadgeClass(chapter.stateId)">
                  {{ chapter.stateName || 'N/A' }}
                </span>
              </td>
              <td class="text-end">
                <div class="d-flex justify-content-end align-items-center gap-2">
                  <div class="btn-group btn-group-sm">
                    <button 
                      class="btn btn-outline-secondary"
                      (click)="moveUp(chapter)"
                      *ngIf="i !== 0"
                      title="Subir posición">
                      <i class="fas fa-arrow-up"></i>
                    </button>
                    <button 
                      class="btn btn-outline-secondary"
                      (click)="moveDown(chapter)"
                      *ngIf="i !== chapters.length - 1"
                      title="Bajar posición">
                      <i class="fas fa-arrow-down"></i>
                    </button>
                  </div>

                  <button 
                    class="btn btn-sm"
                    [ngClass]="isChapterCompleted(chapter.id) ? 'btn-success' : 'btn-danger'"
                    (click)="toggleChapterComplete(chapter)"
                    [title]="isChapterCompleted(chapter.id) ? 'Desmarcar capítulo' : 'Marcar como completado'">
                    <i class="fas me-1" [ngClass]="isChapterCompleted(chapter.id) ? 'fa-check-circle' : 'fa-times-circle'"></i>
                    {{ isChapterCompleted(chapter.id) ? 'Completado' : 'Completar' }}
                  </button>

                  <div class="vr"></div>

                  <div class="btn-group btn-group-sm">
     <button 
    class="btn btn-outline-info"
    (click)="viewChapterContents(chapter)"
    title="Ver contenidos del capítulo">
    <i class="fas fa-eye me-1"></i> Ver Contenidos
  </button>
                    <button *ngIf="authService.canEditModules()"
                      class="btn btn-outline-primary"
                      (click)="editChapter(chapter)"
                      title="Editar capítulo">
                      <i class="fas fa-edit me-1"></i> Editar
                    </button>
                    <button *ngIf="authService.canDeleteModules()"

                      class="btn btn-outline-danger"
                      (click)="deleteChapter(chapter)"
                      title="Eliminar capítulo">
                      <i class="fas fa-trash me-1"></i> Eliminar
                    </button>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div *ngIf="chapters.length === 0" class="text-center text-muted py-4">
        No hay capítulos en este curso
      </div>
    </div>
  </div>
</div>